# 项目架构说明

## 1. 前端架构

### 技术栈与规范
- **组件库**：使用 shadcn 作为主要组件库
  - 开发新功能时优先使用 shadcn 组件
  - 引入新组件使用命令：`npx shadcn@latest add <组件名称>`
  - 组件存放位置：`src/components/ui/` 目录下

- **自定义组件**：非 shadcn 组件存放在 `src/components/` 目录下
  - 业务组件存放在 `src/components/bussiness/` 目录下
  - 通用组件存放在 `src/components/` 根目录下

- **样式方案**：使用 Tailwind CSS 进行样式开发

- **依赖管理**：优先使用 package.json 中已有的依赖库，避免引入不必要的第三方库

### 通信与国际化
- **API 通信**：使用 HTTP 协议与后端通信
  - 接口规范详见：`src/api/README.md`

- **国际化**：使用 i18n 实现多语言支持
  - 使用规范详见：`src/i18n/README.md`

### 前端模块结构

每个功能模块都遵循统一的目录结构：

```
src/pages/
├── ModuleName/
│   ├── ModuleNameListPage.tsx      # 列表页组件
│   ├── ModuleNameFormPage.tsx      # 表单页组件（新增/编辑）
│   └── components/                 # 模块专属组件
│       ├── ModuleNameCreateDialog.tsx  # 创建弹窗组件
│       └── ModuleNameStatusTag.tsx     # 状态标签组件
```

**模块文件命名规范**：
- 列表页：`{ModuleName}ListPage.tsx`
- 表单页：`{ModuleName}FormPage.tsx`
- 弹窗组件：`{ModuleName}{Action}Dialog.tsx`
- 状态标签：`{ModuleName}StatusTag.tsx`

**页面组件通用结构**：

1. **列表页组件**：
   - 数据列表展示（Table组件）
   - 搜索筛选功能（Input, Select, DatePicker等）
   - 分页控制（Paginator组件）
   - 新增/编辑/删除操作
   - 加载状态和骨架屏

2. **表单页组件**：
   - 表单字段输入
   - 表单验证
   - 保存/取消操作
   - 关联数据选择（弹窗选择器）

3. **弹窗组件**：
   - Dialog容器
   - 表单内容
   - 提交/取消操作

## 2. 后端架构

### 核心技术
- **流程引擎**：使用 Node-RED Event Flow 处理前端请求
  - 处理所有前端 HTTP 请求并返回响应

- **数据持久化**：
  - 增删改操作后的数据通过 MQTT 协议转发
  - 使用 Node-RED 的 mqtt-out 节点发送到对应 topic
  - 由订阅该 topic 的服务处理数据落库
  - 所有数据都以 JSONB 格式存储在列名 "json" 下

- **数据查询**：使用 Node-RED 的 PostgreSQL 节点执行数据库查询
  - 查询结果按时间排序，取最新一条数据
  - 返回字段名为 "json"，数据类型为 JSONB

### 后端流程实现

每个模块的后端流程都以 JSON 格式存储在 `flows/` 目录下，命名为 `{module-name}.json`。

**流程节点组成**：

1. **HTTP In 节点**：接收前端请求
   - 配置请求路径和方法
   - 支持 GET/POST 方法

2. **Function 节点**：处理业务逻辑
   - 参数验证
   - 数据过滤和格式化
   - 业务规则实现

3. **PostgreSQL 节点**：数据库操作
   - 查询最新数据
   - 执行 SQL 语句

4. **HTTP Response 节点**：返回响应
   - 配置响应状态码
   - 返回格式化的 JSON 数据

5. **MQTT Out 节点**：数据持久化
   - 将数据发送到指定 topic
   - 用于增删改操作后的数据落库

### API 设计规范

所有 API 都遵循统一的设计规范：

**API 路径**：`/{module}/action`
- 列表查询：`/{module}/list` (POST)
- 详情查询：`/{module}/detail` (GET)
- 创建数据：`/{module}/create` (POST)
- 更新数据：`/{module}/update` (POST)
- 删除数据：`/{module}/delete` (GET)

**请求参数**：
- 列表查询：使用分页参数 `current` 和 `pageSize`，以及其他筛选条件
- 详情查询：使用 ID 参数（如 `bomId`, `inboundId`）
- 增删改：使用完整的数据对象

**响应格式**：
```json
{
  "code": 200,
  "success": true,
  "data": {},
  "message": ""
}
```

**分页响应格式**：
```json
{
  "code": 200,
  "success": true,
  "data": {
    "records": [],
    "total": 100,
    "current": 1,
    "pageSize": 10
  },
  "message": ""
}
```

## 3. 模块开发流程

### 新模块开发步骤
1. **模块创建**：
   - 创建前端页面组件
   - 创建 API 接口文件
   - 创建类型定义文件
   - 创建后端流程文件

2. **功能实现**：
   - 根据前后端架构规范实现页面功能
   - 确保前端界面与后端 API 正确对接
   - 实现数据的完整流转

3. **后端流程**：
   - 生成 Node-RED flow 代码
   - 以 JSON 格式存储在 `flow` 目录中

### 质量要求
- 前后端功能必须符合需求逻辑
- 确保数据在各环节流通顺畅
- 保持代码结构清晰，便于维护

## 4. 数据流转规范

### 数据流向

1. **前端发起请求** → 2. **Node-RED HTTP In 节点接收** → 3. **参数验证和处理** → 4. **数据库查询** → 5. **数据格式化** → 6. **返回响应**

对于增删改操作：

1. **前端发起请求** → 2. **Node-RED HTTP In 节点接收** → 3. **参数验证和处理** → 4. **数据库查询（获取现有数据）** → 5. **业务逻辑处理** → 6. **MQTT 发送数据** → 7. **返回响应**

### 数据存储格式

所有数据都以 JSONB 格式存储在数据库的 "json" 列中，包含：
- 业务字段数据
- 创建时间和更新时间
- 其他元数据

## 6. 常见问题与检查清单

### 6.1 组件使用一致性
- [ ] 所有表单组件（输入框、选择框、按钮等）是否使用了 shadcn 组件库
- [ ] 避免混合使用原生 HTML 元素和 shadcn 组件
- [ ] 确保导入了正确的 shadcn 组件及其子组件

### 6.2 类型定义一致性
- [ ] 接口是否正确继承了基础接口
- [ ] 避免重复定义已在父接口中存在的属性
- [ ] 确保类型引用正确，无拼写错误

### 6.3 国际化
- [ ] 所有用户可见文本是否都使用了国际化词条
- [ ] 国际化词条名是否符合统一的命名规范
- [ ] 中英文词条是否一一对应

### 6.4 代码维护
- [ ] 定期检查并替换过时的组件使用方式
- [ ] 确保所有组件都遵循项目的技术栈规范
- [ ] 保持代码风格和结构的一致性

### 6.5 后端流程检查
- [ ] HTTP In 节点是否配置了正确的路径和方法
- [ ] 数据查询是否按时间排序并取最新记录
- [ ] 增删改操作是否正确发送 MQTT 消息
- [ ] 响应格式是否符合 API 规范